<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>המשפחה שלי</title>
  
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <style>
    body { 
      font-family: 'Assistant', sans-serif; 
      background-color: #f3f4f6;
      overscroll-behavior: none; /* מניעת pull-to-refresh */
    }
    input { font-size: 16px; }
  </style>
</head>

<body>
  <script>
    window.serverData = <?!= serverData ?>;
  </script>

  <div id="root"></div>

  <script type="text/babel">
    const SearchBox = ({ onSearch, onSelect }) => {
      const [searchTerm, setSearchTerm] = React.useState('');
      const [suggestions, setSuggestions] = React.useState([]);
      const inputRef = React.useRef(null);

      const handleSearch = (value) => {
        setSearchTerm(value);
        if (!value.trim()) {
          setSuggestions([]);
          onSearch('');
          return;
        }

        const filtered = window.serverData.people.filter(person => 
          person.firstName.includes(value) ||
          person.lastName.includes(value)
        );
        
        setSuggestions(filtered);
        onSearch(value);
      };

      const handleSelect = (person) => {
        setSearchTerm(`${person.firstName} ${person.lastName}`);
        setSuggestions([]);
        onSelect(person);
        inputRef.current?.blur();
      };

      return (
        <div className="position-relative">
          <input
            ref={inputRef}
            type="text"
            value={searchTerm}
            onChange={(e) => handleSearch(e.target.value)}
            placeholder="חפש שם פרטי או שם משפחה..."
            className="form-control"
          />
          
          {suggestions.length > 0 && (
            <div className="position-absolute w-100 mt-1 bg-white rounded-lg border shadow-lg max-h-60 overflow-auto z-10">
              {suggestions.map((person) => (
                <div
                  key={person.id}
                  onClick={() => handleSelect(person)}
                  className="p-2 hover:bg-gray-50 cursor-pointer"
                >
                  {person.firstName} {person.lastName}
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    const FamilyCard = ({ person, allPeople, relations, isExpanded, onToggle }) => {
      // מציאת קשרים משפחתיים
      const getRelatives = () => {
        const parents = relations.filter(r => 
          r.relationType === 'parent' && 
          r.personId2 === person.id
        ).map(r => allPeople.find(p => p.id === r.personId1));

        const children = relations.filter(r => 
          r.relationType === 'parent' && 
          r.personId1 === person.id
        ).map(r => allPeople.find(p => p.id === r.personId2));

        const siblings = relations
          .filter(r => r.relationType === 'parent')
          .filter(r => {
            const personParents = relations
              .filter(pr => pr.relationType === 'parent' && pr.personId2 === person.id)
              .map(pr => pr.personId1);
            return personParents.includes(r.personId1) && r.personId2 !== person.id;
          })
          .map(r => allPeople.find(p => p.id === r.personId2));

        return { parents, children, siblings };
      };

      const { parents, children, siblings } = getRelatives();

      return (
        <div className="mb-4">
          {/* כרטיס ראשי */}
          <div 
            onClick={() => onToggle(person.id)}
            className={`bg-white rounded-lg shadow-lg p-4 cursor-pointer transition-all w-100 
              ${isExpanded ? 'ring-2 ring-blue-500' : 'hover:bg-gray-50'}`}
          >
            {/* הורים בקטן למעלה */}
            {parents.length > 0 && (
              <div className="text-xs text-gray-500 mb-1">
                הורים: {parents.map(p => `${p.firstName} ${p.lastName}`).join(' | ')}
              </div>
            )}
            
            {/* שם האדם */}
            <div className="text-xl font-medium">{person.firstName} {person.lastName}</div>
            
            {/* ילדים בקטן למטה */}
            {children.length > 0 && (
              <div className="text-xs text-gray-500 mt-1">
                ילדים: {children.map(c => `${c.firstName} ${c.lastName}`).join(' | ')}
              </div>
            )}
          </div>

          {/* תצוגה מורחבת */}
          {isExpanded && (
            <div className="mt-2 space-y-3">
              {/* הורים */}
              {parents.length > 0 && (
                <div className="space-y-2">
                  <div className="text-sm text-gray-500 font-medium">הורים:</div>
                  {parents.map(parent => (
                    <div key={parent.id} className="bg-white rounded-lg shadow p-3 w-100">
                      <div className="font-medium">{parent.firstName} {parent.lastName}</div>
                      {parent.nickname && (
                        <div className="text-sm text-gray-500">{parent.nickname}</div>
                      )}
                    </div>
                  ))}
                </div>
              )}

              {/* אחים */}
              {siblings.length > 0 && (
                <div className="space-y-2">
                  <div className="text-sm text-gray-500 d-flex justify-content-between align-items-center">
                    <span>אחים:</span>
                    <span className="text-xs text-gray-400">
                      {/* מספר האח הנוכחי מתוך הסך הכל */}
                      {siblings.length > 1 ? 'החלק לצדדים לאחים נוספים' : ''}
                    </span>
                  </div>
                  <div className="position-relative">
                    <div className="overflow-hidden">
                      <div className="d-flex snap-x snap-mandatory overflow-x-auto scrollbar-hide">
                        {siblings.map(sibling => (
                          <div 
                            key={sibling.id}
                            className="snap-center shrink-0 w-100 scroll-smooth"
                          >
                            <div className="bg-gray-50 rounded-lg p-3 mx-1">
                              <div className="font-medium">
                                {sibling.firstName} {sibling.lastName}
                              </div>
                              {sibling.nickname && (
                                <div className="text-sm text-gray-500">
                                  {sibling.nickname}
                                </div>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* ילדים */}
              {children.length > 0 && (
                <div className="space-y-2">
                  <div className="text-sm text-gray-500 font-medium">ילדים:</div>
                  {children.map(child => (
                    <div key={child.id} className="bg-white rounded-lg shadow p-3 w-100">
                      <div className="font-medium">{child.firstName} {child.lastName}</div>
                      {child.nickname && (
                        <div className="text-sm text-gray-500">{child.nickname}</div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      );
    };

    function App() {
      const [data] = React.useState(window.serverData);
      const [filteredPeople, setFilteredPeople] = React.useState(data?.people || []);
      const [expandedCards, setExpandedCards] = React.useState(new Set());

      const handleSearch = (term) => {
        if (!term) {
          setFilteredPeople(data?.people || []);
          return;
        }

        const filtered = data?.people.filter(person => 
          person.firstName.includes(term) ||
          person.lastName.includes(term)
        );
        setFilteredPeople(filtered);
      };

      const handleSelect = (person) => {
        setFilteredPeople([person]);
        setExpandedCards(new Set([person.id]));
      };

      const toggleCard = (personId) => {
        setExpandedCards(prev => {
          const next = new Set(prev);
          if (next.has(personId)) {
            next.delete(personId);
          } else {
            next.add(personId);
          }
          return next;
        });
      };

      if (!data || !data.people) {
        return (
          <div className="d-flex justify-content-center align-items-center min-vh-100">
            <div className="text-center">לא נמצאו נתונים</div>
          </div>
        );
      }

      return (
        <div 
          className="w-100 sm:w-11/12 md:w-3/4 mx-auto p-4 min-vh-100"
        >
          <h1 className="text-2xl font-bold text-center mb-6">המשפחה שלי</h1>
          
          <div className="mb-6">
            <SearchBox 
              onSearch={handleSearch}
              onSelect={handleSelect}
            />
          </div>

          <div>
            {filteredPeople.map((person) => (
              <FamilyCard 
                key={person.id}
                person={person}
                allPeople={data.people}
                relations={data.relations}
                isExpanded={expandedCards.has(person.id)}
                onToggle={toggleCard}
              />
            ))}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>